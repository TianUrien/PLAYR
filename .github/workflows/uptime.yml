name: Uptime Monitor

on:
  schedule:
    - cron: '*/5 * * * *'
  workflow_dispatch:

jobs:
  health-check:
    name: Health Check
    runs-on: ubuntu-latest

    steps:
      - name: Ping health endpoint
        id: health
        run: |
          HTTP_STATUS=$(curl -s -o /tmp/health-response.json -w "%{http_code}" \
            --max-time 30 \
            "https://xtertgftujnebubxgqit.supabase.co/functions/v1/health")

          echo "status=$HTTP_STATUS" >> $GITHUB_OUTPUT

          if [ "$HTTP_STATUS" -ne 200 ]; then
            echo "Health check failed with status $HTTP_STATUS"
            cat /tmp/health-response.json || true
            exit 1
          fi

          echo "Health check passed (HTTP $HTTP_STATUS)"
          cat /tmp/health-response.json | python3 -m json.tool || true

      - name: Create issue on failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const title = `[Uptime] Health check failed at ${new Date().toISOString()}`
            const body = [
              `The production health endpoint returned a non-200 status.`,
              ``,
              `**HTTP Status**: \`${{ steps.health.outputs.status || 'timeout/error' }}\``,
              `**Endpoint**: \`https://xtertgftujnebubxgqit.supabase.co/functions/v1/health\``,
              `**Time**: ${new Date().toISOString()}`,
              ``,
              `Please investigate immediately.`,
              ``,
              `_This issue was created automatically by the uptime monitor._`,
            ].join('\n')

            const existing = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: 'uptime',
              state: 'open',
              per_page: 1,
            })

            if (existing.data.length > 0) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: existing.data[0].number,
                body: `Still failing at ${new Date().toISOString()}. HTTP status: \`${{ steps.health.outputs.status || 'unknown' }}\``,
              })
            } else {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title,
                body,
                labels: ['uptime', 'bug'],
              })
            }
